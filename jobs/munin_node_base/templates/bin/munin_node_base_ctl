#!/bin/bash
#

set -e

NAME="munin-node"
DESC="munin node"
USER=munin

PID_FILE=/var/run/munin/munin-node.pid
INIT_LOG_DIR=/var/log/munin

TIMESTAMP=$(which date)

RETVAL=0

force_link_plugin() {
  LINK_FROM_NAME=$1
  LINK_TO_NAME=$2
  ln -sf /usr/share/munin/plugins/$LINK_FROM_NAME /etc/munin/plugins/$LINK_TO_NAME
}

start_munin_node() {
  # default installation for all installs
  cp /var/vcap/jobs/munin_node_base/etc/munin/munin-node.conf /etc/munin/munin-node.conf

  # ensure that all of the plugins are enabled and ready to run...
  PLUGINS=( "cpu" "df" "df_inode" "diskstats" "entropy" "forks" "interrupts" "irqstats" "load" "lpstat" "memory" "open_files" "open_inodes" "processes" "proc_pri" "swap" "threads" "uptime" "users" "vmstat" )
  for i in "${PLUGINS[@]}"
  do
      force_link_plugin $i $i
  done

  # now for the ethernet ports
  /sbin/ifconfig -s -a | grep eth | cut -d " " -f 1 | while read i
  do
      force_link_plugin if_err_ if_err_$i
      force_link_plugin if_ if_$i
  done

  ############################################################################
  #
  #  MUNIN HA PROXY CONFIGURATION
  #
  ############################################################################
  if [ -d /var/vcap/jobs/haproxy ] 
  then
    cp /var/vcap/jobs/munin_node_haproxy/etc/munin/plugin-conf.d/haproxy /etc/munin/plugin-conf.d/haproxy
    cp /var/vcap/jobs/munin_node_haproxy/usr/share/munin/plugins/* /usr/share/munin/plugins/
    chmod a+rx /usr/share/munin/plugins/*
    # go through and link in all of the munin haproxy plugins
    ls /usr/share/munin/plugins/haproxy* | while read i ; do ln -sf $i /etc/munin/plugins/`basename $i`; done
  fi


  /usr/sbin/service munin-node start \
    1>> "${INIT_LOG_DIR}/munin_node_startup_stdout.log" \
    2>> "${INIT_LOG_DIR}/munin_node_startup_stderr.log" \
    0<&-
}

stop_munin_node() {
    /usr/sbin/service munin-node stop \
      1>> "${INIT_LOG_DIR}/munin_node_startup_stdout.log" \
      2>> "${INIT_LOG_DIR}/munin_node_startup_stderr.log" \
      0<&-
}

restart_munin_node() {
  stop_munin_node
  start_munin_node
}

case "$1" in
  start)
    echo -n "Starting ${DESC}: "
    start_munin_node
    echo "${NAME}."
    ;;
  stop)
    echo -n "Stopping ${DESC}: "
    stop_munin_node
    echo "${NAME}."
    ;;
  force-reload|reload|restart)
    echo -n "Restarting ${DESC}: "
    restart_munin_node
    echo "${NAME}."
    ;;
  *)
    echo "Usage: $0 {start|stop|restart|reload|force-reload}" >&2
    RETVAL=1
    ;;
esac

exit "${RETVAL}"
