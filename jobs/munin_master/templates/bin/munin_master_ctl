#!/bin/bash

PID_FILE="/var/run/munin/munin-node.pid"
INIT_LOG_DIR="/var/log/munin"

# exit immediately if a simple command exits with a non-zero status
set -e 

force_link_plugin() {
  LINK_FROM_NAME=$1
  LINK_TO_NAME=$2
  ln -sf /usr/share/munin/plugins/$LINK_FROM_NAME /etc/munin/plugins/$LINK_TO_NAME
}

start_munin() {
  # this will create the /etc/munin/munin.conf file
  /var/vcap/jobs/munin_master/bin/update_munin_conf.py

  cp /var/vcap/jobs/munin_master/etc/munin/munin-node.conf /etc/munin/munin-node.conf

  cp /var/vcap/jobs/munin_master/etc/munin/plugin-conf.d/munin /etc/munin/plugin-conf.d/munin

  cp /var/vcap/jobs/munin_master/etc/cron.d/munin /etc/cron.d/munin
  cp /var/vcap/jobs/munin_master/etc/cron.d/munin-config-updater /etc/cron.d/munin-config-updater

  chmod a+rwx /tmp

  # default installation for all installs
  cp /var/vcap/jobs/munin_master/etc/munin/munin-node.conf /etc/munin/munin-node.conf

  # ensure that all of the plugins are enabled and ready to run...
  PLUGINS=( "cpu" "df" "df_inode" "diskstats" "entropy" "forks" "interrupts" "irqstats" "load" "lpstat" "memory" "open_files" "open_inodes" "processes" "proc_pri" "swap" "threads" "uptime" "users" "vmstat" )

  for i in "${PLUGINS[@]}"
  do
      force_link_plugin $i $i
  done

  # now for the ethernet ports 
  /sbin/ifconfig -s -a | grep eth | cut -d " " -f 1 | while read i
  do
      force_link_plugin if_err_ if_err_$i
      force_link_plugin if_ if_$i
  done

  PLUGINS=( "munin_stats" "munin_update" "nginx_request" "nginx_status")
  for i in "${PLUGINS[@]}"
  do
      force_link_plugin $i $i
  done

  rm -f $PID_FILE
  if [ `ps -ef | grep munin-node | grep -v grep | wc -l` = 1 ]
  then
    killall munin-node
  fi
  /usr/sbin/munin-node
  exit 0
}

stop_munin() {
  if [ `ps -ef | grep munin-node | grep -v grep | wc -l` = 1 ]
  then
    killall munin-node
  fi
  exit 0
}

case "$1" in
  start)
    echo -n "Starting ${DESC}: "
    start_munin
    echo "${NAME}."
    ;;
  stop)
    echo -n "Stopping ${DESC}: "
    stop_munin
    echo "${NAME}."
    ;;
  force-reload|reload|restart)
    echo -n "Restarting ${DESC}: "
    stop_munin
    start_munin
    echo "${NAME}."
    ;;
  *)
    echo "Usage: $0 {start|stop|restart|reload|force-reload}" >&2
    exit 1
    ;;
esac
exit 0
