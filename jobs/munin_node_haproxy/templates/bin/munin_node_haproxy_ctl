#!/bin/bash

set -e # exit immediately if a simple command exits with a non-zero status
start_munin() {
    cp /var/vcap/jobs/munin_node_haproxy/etc/munin/plugin-conf.d/haproxy /etc/munin/plugin-conf.d/haproxy
    cp /var/vcap/jobs/munin_node_haproxy/usr/share/munin/plugins/* /usr/share/munin/plugins/
    chmod a+rx /usr/share/munin/plugins/*
    # go through and link in all of the munin haproxy plugins
    ls /usr/share/munin/plugins/haproxy* | while read i ; do ln -sf $i /etc/munin/plugins/`basename $i`; done

    service munin-node start \
      1>> "${INIT_LOG_DIR}/startup_stdout.log" \
      2>> "${INIT_LOG_DIR}/startup_stderr.log" \
      0<&-
}

stop_munin() {
    service munin-node stop \
      1>> "${INIT_LOG_DIR}/startup_stdout.log" \
      2>> "${INIT_LOG_DIR}/startup_stderr.log" \
      0<&-
}
case $1 in

  start)
    start_munin
    ;;
  stop)
    stop_munin
    ;;
  force-reload|reload|restart)
    start_munin
    stop_munin
    ;;
  *)
    echo "Usage: $0 {start|stop|restart|reload|force-reload}" >&2
    exit 1
    ;;
esac

exit 0